/*!
 * HTML5刮奖组件
 * @license 766.com
 * Created:2014-4-18
 * Update:2014-4-24
 * Author:mudoo
 * Support:https://github.com/artwl/Lottery
 */
function scratchLottery(t,s){if(!this.supported())throw new Error("\u60a8\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301HTML5\uff0c\u8bf7\u4f7f\u7528Firefox\u3001Chrome\u3001IE9+\u7b49\u65b0\u7248\u672c\u6d4f\u89c8\u5668");if(this.boxID=t,this.box=document.getElementById(this.boxID),!this.box)throw new Error("\u5bb9\u5668\u5bf9\u8c61\u4e0d\u5b58\u5728");var i={lottery:"\u8c22\u8c22\u53c2\u4e0e\n\u5206\u4eab\u5230\u5fae\u535a\u518d\u6765\u4e00\u6b21",mask:"#ccc",width:0,height:0,lotteryCanvas:null,lotteryType:null,text:{bgColor:"#fff",font:"Microsoft YaHei",style:"Bold",size:0,color:"#f60",styleOther:"",sizeOther:0,colorOther:"#666",margin:[.15,.1],space:0,align:"center"},useImageSize:!1,maskCanvas:null,maskType:null,scratchType:"line",scratchWidth:0,openPct:50,onscratch:null,onopen:null};this.opts=this.extend(i,s),this.opts.lotteryType||(this.opts.lotteryType=this.checkType(this.opts.lottery)),this.opts.maskType||(this.opts.maskType=this.checkType(this.opts.mask,1)),this.opts.width&&this.opts.height||(this.opts.width=this.box.offsetWidth,this.opts.height=this.box.offsetHeight,this.useBoxSize=!0),this.lotteryCanvas=null,this.lotteryCtx=null,this.maskCanvas=null,this.maskCtx=null,this.startDraw=!1,this.openCalled=!1,this.onopenBak=this.opts.onopen,this.isAndroid=navigator.userAgent.match(/Android/i),this.marginPX=[Math.round(this.opts.height*this.opts.text.margin[0]),Math.round(this.opts.width*this.opts.text.margin[1])],this.originalWidth=this.opts.width,this.originalHeight=this.opts.height,this.scalePct=[1,1],this.lastCall=(new Date).getTime(),this.device=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()),this.drawCall="point"==this.opts.scratchType?this.drawPoint:this.drawLine,this.getScratchWidth(),this.build()}scratchLottery.prototype={extend:function(t,s){for(var i in s)t[i]="object"!=typeof s[i]||void 0==t[i]||s[i].length?s[i]:this.extend(t[i],s[i]);return t},supported:function(){var t=document.createElement("canvas");return t.getContext&&t.getContext("2d")},parseTextStyle:function(){var t,s,i,e,h,o,a,n,r,l,p,c;if("text"==this.opts.lotteryType){for(this.opts.lottery=this.opts.lottery.replace(/^\n+|\n+$/g,"").replace(/\n+/g,"\n").split("\n"),this.opts.text.space||(this.opts.text.space=Math.round(this.opts.height/20)),(this.opts.text.size>0||this.opts.text.sizeOther>0)&&this.opts.text.size>0&&0==this.opts.text.sizeOther&&(this.opts.text.sizeOther=Math.round(this.opts.text.size)),t=this.opts.text,s=this.opts.lottery.length,i=10,e=[],h=0,o=0,a=[this.opts.height-2*this.marginPX[0],this.opts.width-2*this.marginPX[1]],n=1.8,p=0;s>p;p++)0==p?this.lotteryCtx.font=[t.style,i*n+"px",t.font].join(" ").trim():1==p&&(this.lotteryCtx.font=[t.style,i+"px",t.font].join(" ").trim()),c=this.lotteryCtx.measureText(this.opts.lottery[p]).width,c>o&&(o=c,h=p),e.push(c);r=Math.min((a[0]-t.space*(s-1))/(i*n+i*(s-1)),a[1]/o),l=[i*n*r,i*r],this.opts.text.size=Math.max(Math.round(l[0]),16),this.opts.text.sizeOther=Math.max(Math.round(l[1]),12)}},getScratchWidth:function(){this.opts.scratchWidth>0&&this.originalWidth==this.opts.width||(this.opts.scratchWidth=Math.round(this.opts.width/("line"==this.opts.scratchType?30:20)),this.opts.scratchWidth=Math.max(this.opts.scratchWidth,"line"==this.opts.scratchType?8:10),this.opts.scratchWidth=Math.min(this.opts.scratchWidth,"line"==this.opts.scratchType?15:30))},checkType:function(t,s){if(!t||""==t)throw new Error("\u80cc\u666f\u6216\u906e\u7f69\u53c2\u6570\u65e0\u6548");var i=t.substring(t.length-5);return/^http:\/\/|\.[a-z]{3,4}$/i.test(i)?"image":s?"color":"text"},getXY:function(t){var s=document.documentElement,i=this.box.getBoundingClientRect(),e=(this.device?t.touches[0].clientX:t.clientX)-i.left-s.clientLeft,h=(this.device?t.touches[0].clientY:t.clientY)-i.top-s.clientTop;return{x:e/this.scalePct[0],y:h/this.scalePct[1]}},createElement:function(t,s){var i,e=document.createElement(t);for(i in s)e.setAttribute(i,s[i]);return e},getTransparentPercent:function(t,s,i){var e,h,o,a=t.getImageData(0,0,s,i),n=a.data,r=[];for(e=0,h=n.length;h>e;e+=4)o=n[e+3],128>o&&r.push(e);return(r.length/(n.length/4)*100).toFixed(2)},resizeCanvas:function(t,s,i){t.width=s,t.height=i,t.getContext("2d").clearRect(0,0,s,i)},callback:function(){var t,s=(new Date).getTime();s-this.lastCall<100||(this.lastCall=s,t=this.getTransparentPercent(this.maskCtx,this.originalWidth,this.originalHeight),!this.openCalled&&t>this.opts.openPct&&(this.openCalled=!0,this.resizeCanvas(this.maskCanvas,this.opts.width,this.opts.height),this.opts.onopen&&(this.opts.onopen.call(null,t),this.opts.onopen=null),t=100),this.opts.onscratch&&this.opts.onscratch.call(null,t))},drawPoint:function(t,s){this.maskCtx.beginPath();var i=this.maskCtx.createRadialGradient(t,s,0,t,s,this.opts.scratchWidth);i.addColorStop(0,"rgba(0,0,0,0.9)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),this.maskCtx.fillStyle=i,this.maskCtx.arc(t,s,this.opts.scratchWidth,0,2*Math.PI,!0),this.maskCtx.fill(),this.isAndroid&&(this.maskCanvas.style.marginRight="0px"==this.maskCanvas.style.marginRight?"1px":"0px"),(this.opts.openPct>0||this.opts.onscratch||this.opts.onopen)&&this.callback()},drawLine:function(t,s){this.maskCtx.strokeStyle="#fff",this.maskCtx.lineWidth=this.opts.scratchWidth,this.startDraw?(this.maskCtx.lineTo(t,s),this.maskCtx.stroke()):(this.maskCtx.beginPath(),this.maskCtx.moveTo(t,s),this.startDraw=!0),this.isAndroid&&(this.maskCanvas.style.marginRight="0px"==this.maskCanvas.style.marginRight?"1px":"0px"),(this.opts.openPct>0||this.opts.onscratch||this.opts.onopen)&&this.callback()},bindEvent:function(){var t,s,i,e;t=this,s=this.device?"touchstart":"mousedown",i=this.device?"touchmove":"mousemove",this.device?(document.addEventListener("touchmove",function(t){e&&(t.preventDefault(),t.stopPropagation())},!1),document.addEventListener("touchend",function(){e=!1,t.startDraw=!1},!1)):(e=!1,document.addEventListener("mouseup",function(){e=!1,t.startDraw=!1},!1)),this.maskCanvas.addEventListener(s,function(s){if(1==t.openCalled)return!1;e=!0;var i=t.getXY(s);t.drawCall(i.x,i.y)},!1),this.maskCanvas.addEventListener(i,function(s){if(1==t.openCalled)return e=!1,t.startDraw=!1,!1;if(!t.device&&!e)return!1;var i=t.getXY(s);t.drawCall(i.x,i.y)},!1),this.useBoxSize&&window.addEventListener("resize",function(){var s=t.box.offsetWidth,i=t.box.offsetHeight;t.resize(s,i)})},build:function(){this.lotteryCanvas=this.opts.lotteryCanvas||this.createElement("canvas",{style:"position:absolute;left:0;top:0;"}),this.maskCanvas=this.opts.maskCanvas||this.createElement("canvas",{style:"position:absolute;left:0;top:0;"}),this.box.appendChild(this.lotteryCanvas),this.box.appendChild(this.maskCanvas),this.bindEvent(),this.lotteryCtx=this.lotteryCanvas.getContext("2d"),this.maskCtx=this.maskCanvas.getContext("2d"),this.parseTextStyle(),this.drawMask()},drawLottery:function(){var t,s,i,e,h,o,a,n,r,l;if("image"==this.opts.lotteryType)t=new Image,s=this,t.onload=function(){s.opts.useImageSize&&(s.opts.width=this.width,s.opts.height=this.height),s.resizeCanvas(s.lotteryCanvas,s.opts.width,s.opts.height),s.lotteryCtx.drawImage(this,0,0,s.opts.width,s.opts.height)},t.onerror=function(){throw new Error("\u80cc\u666f\u56fe\u7247\u52a0\u8f7d\u5931\u8d25\uff1a"+s.opts.lottery)},t.src=this.opts.lottery;else if("text"==this.opts.lotteryType)for(i=this.opts.text,e=this.opts.lottery,h=e.length,o=[i.style,i.size+"px",i.font].join(" ").trim(),a=[i.styleOther,i.sizeOther+"px",i.font].join(" ").trim(),n=i.size+i.space*Math.max(h-1,0)+i.sizeOther*Math.max(h-1,0),r=["left"==i.align?this.marginPX[1]:"right"==i.align?this.opts.width-this.marginPX[1]:this.opts.width/2,(this.opts.height-n)/2+i.size-Math.round(n/10)-Math.round(i.size/20)],this.resizeCanvas(this.lotteryCanvas,this.opts.width,this.opts.height),this.lotteryCtx.save(),this.lotteryCtx.fillStyle=i.bgColor,this.lotteryCtx.fillRect(0,0,this.opts.width,this.opts.height),this.lotteryCtx.restore(),this.lotteryCtx.save(),this.lotteryCtx.font=o,this.lotteryCtx.textAlign=i.align,this.lotteryCtx.fillStyle=i.color,this.lotteryCtx.fillText(e[0],r[0],r[1]),this.lotteryCtx.restore(),l=1;h>l;l++)r[1]=r[1]+(1==l?i.size/2:i.sizeOther/2)+i.sizeOther/2+i.space,this.lotteryCtx.save(),this.lotteryCtx.font=a,this.lotteryCtx.textAlign=i.align,this.lotteryCtx.fillStyle=i.colorOther,this.lotteryCtx.fillText(e[l],r[0],r[1]),this.lotteryCtx.restore()},drawMask:function(){if(this.resizeCanvas(this.maskCanvas,this.opts.width,this.opts.height),"color"==this.opts.maskType)this.maskCtx.fillStyle=this.opts.mask,this.maskCtx.fillRect(0,0,this.opts.width,this.opts.height),this.maskCtx.globalCompositeOperation="destination-out",this.drawLottery();else if("image"==this.opts.maskType){var t=new Image,s=this;t.onload=function(){s.maskCtx.drawImage(this,0,0,s.opts.width,s.opts.height),s.maskCtx.globalCompositeOperation="destination-out",s.drawLottery()},t.onerror=function(){throw new Error("\u906e\u7f69\u56fe\u7247\u52a0\u8f7d\u5931\u8d25\uff1a"+s.opts.mask)},t.src=this.opts.mask}},resize:function(t,s){if(t=parseInt(t,10),s=parseInt(s,10),!(isNaN(t)||isNaN(s)||this.opts.width==t&&this.opts.height==s)){var i=t/this.originalWidth,e=s/this.originalHeight;this.opts.width=t,this.opts.height=s,this.scalePct=[i,e]}},init:function(t,s){t&&(this.opts.lottery=t,this.opts.lotteryType=s||this.checkType(t),this.parseTextStyle()),this.openCalled&&(this.openCalled=!1,this.opts.onopen=this.onopenBak),this.getScratchWidth(),this.originalWidth=this.opts.width,this.originalHeight=this.opts.height,this.scalePct=[1,1],this.drawMask()}},String.prototype.trim=function(t){var s=/^[\s\t]+|[\s\t]+$/g;return("l"==t||"left"==t)&&(s=/^[\s\t]+/g),("r"==t||"right"==t)&&(s=/[\s\t]+$/g),this.replace(s,"")};